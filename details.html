<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Details - Blockchain Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 260px;
            background: #1a202c;
            color: white;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #2d3748;
        }

        .sidebar-header h1 {
            font-size: 1.5em;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 0.85em;
            color: #a0aec0;
        }

        .nav-menu {
            padding: 16px 0;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: #cbd5e0;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 0.95em;
        }

        .nav-item:hover {
            background: #2d3748;
            color: white;
            border-left-color: #4299e1;
        }

        .nav-item.active {
            background: #2d3748;
            color: white;
            border-left-color: #4299e1;
            font-weight: 600;
        }

        .nav-item-icon {
            margin-right: 12px;
            width: 20px;
            display: inline-block;
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
        }

        .top-bar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .page-title {
            font-size: 1.75em;
            font-weight: 700;
            color: #1a202c;
        }

        .content-area {
            padding: 32px;
        }

        .content {
            padding: 0;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
            padding: 24px;
        }

        .price-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border-left: 4px solid #48bb78;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .price-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1a202c;
        }

        .price-value {
            font-size: 2em;
            font-weight: 700;
            color: #48bb78;
        }

        .price-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .price-detail {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .price-detail-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .price-detail-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 600;
        }

        .search-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-wrapper {
            flex: 1;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: white;
            background: #4299e1;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        button:hover {
            background: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 20px;
            border-radius: 8px;
            color: #c33;
            margin: 20px 0;
        }

        .error-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .transaction-pricing {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .transaction-pricing:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .pricing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .tx-id {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
            word-break: break-all;
            flex: 1;
            margin-right: 15px;
        }

        .usd-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #28a745;
        }

        .pricing-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .pricing-item {
            display: flex;
            flex-direction: column;
        }

        .pricing-label {
            font-size: 0.8em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .pricing-value {
            font-size: 0.95em;
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .tax-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .tax-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }

        .tax-note {
            font-size: 0.9em;
            color: #856404;
            line-height: 1.5;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .no-results-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }

            .input-group {
                flex-direction: column;
            }

            .pricing-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .tx-id {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .pricing-details {
                grid-template-columns: 1fr;
            }

            .price-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>üîó Blockchain Explorer</h1>
            <p>Bitcoin & Sidechain Explorer</p>
        </div>
        <nav class="nav-menu">
            <a href="/" class="nav-item">
                <span class="nav-item-icon">üè†</span> Home
            </a>
            <a href="/block" class="nav-item">
                <span class="nav-item-icon">üß±</span> Block Viewer
            </a>
            <a href="/transaction" class="nav-item">
                <span class="nav-item-icon">üîó</span> Transaction Viewer
            </a>
            <a href="/latest-blocks" class="nav-item">
                <span class="nav-item-icon">üìã</span> Latest Blocks
            </a>
            <a href="/mempool" class="nav-item">
                <span class="nav-item-icon">üíæ</span> Mempool
            </a>
            <a href="/details" class="nav-item active">
                <span class="nav-item-icon">üìä</span> Pricing Details
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <h1 class="page-title">üìä Pricing Details</h1>
        </div>

        <div class="content-area">
            <div class="content">
            <!-- Current Bitcoin Price Section -->
            <div class="price-section">
                <div class="price-header">
                    <div class="price-title">Current Bitcoin Price</div>
                    <div class="price-value" id="currentPrice">Loading...</div>
                </div>
                <div class="price-details">
                    <div class="price-detail">
                        <div class="price-detail-label">Last Updated</div>
                        <div class="price-detail-value" id="lastUpdated">-</div>
                    </div>
                    <div class="price-detail">
                        <div class="price-detail-label">Source</div>
                        <div class="price-detail-value">CoinDesk API</div>
                    </div>
                    <div class="price-detail">
                        <div class="price-detail-label">Cache Status</div>
                        <div class="price-detail-value" id="cacheStatus">-</div>
                    </div>
                </div>
            </div>

            <!-- Transaction Search Section -->
            <div class="search-section">
                <div class="search-title">Transaction Pricing Calculator</div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="transactionInput" 
                            placeholder="Enter transaction ID (e.g., abc123...)" 
                            autocomplete="off"
                        />
                    </div>
                    <button id="calculateBtn" onclick="calculateTransactionPricing()">Calculate USD Value</button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results"></div>
        </div>
    </div>

    <script>
        // API endpoints
        const PRICE_API_URL = '/api/bitcoin/price';
        const PRICING_API_URL = '/api/transaction';

        // Load current Bitcoin price on page load
        async function loadCurrentPrice() {
            try {
                const response = await fetch(PRICE_API_URL);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('currentPrice').textContent = `$${data.price_usd.toLocaleString()}`;
                    document.getElementById('lastUpdated').textContent = new Date(data.timestamp).toLocaleString();
                    document.getElementById('cacheStatus').textContent = 'Live';
                } else {
                    document.getElementById('currentPrice').textContent = 'Error';
                    document.getElementById('cacheStatus').textContent = 'Error';
                }
            } catch (error) {
                document.getElementById('currentPrice').textContent = 'Error';
                document.getElementById('cacheStatus').textContent = 'Error';
            }
        }

        // Allow Enter key to trigger calculation
        document.getElementById('transactionInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateTransactionPricing();
            }
        });

        async function calculateTransactionPricing() {
            const txid = document.getElementById('transactionInput').value.trim();
            const resultsDiv = document.getElementById('results');
            const calculateBtn = document.getElementById('calculateBtn');

            // Validation
            if (!txid) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <div class="error-title">‚ö†Ô∏è Validation Error</div>
                        <div>Please enter a valid transaction ID</div>
                    </div>
                `;
                return;
            }

            // Show loading state
            calculateBtn.disabled = true;
            calculateBtn.textContent = 'Calculating...';
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Calculating USD value for transaction: <strong>${txid}</strong></div>
                </div>
            `;

            try {
                const url = `${PRICING_API_URL}/${txid}/pricing`;
                const response = await fetch(url);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                displayPricingResults(data);

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <div class="error-title">‚ùå Error Calculating Pricing</div>
                        <div><strong>Message:</strong> ${error.message}</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            Please check:
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>The transaction ID is correct</li>
                                <li>The transaction exists on the blockchain</li>
                                <li>The backend server is running</li>
                            </ul>
                        </div>
                    </div>
                `;
            } finally {
                calculateBtn.disabled = false;
                calculateBtn.textContent = 'Calculate USD Value';
            }
        }

        function displayPricingResults(data) {
            const resultsDiv = document.getElementById('results');

            const html = `
                <div class="transaction-pricing">
                    <div class="pricing-header">
                        <div class="tx-id">
                            <strong>Transaction:</strong> ${data.transaction_id}
                        </div>
                        <div class="usd-value">
                            $${data.usd_value.toLocaleString(2)}
                        </div>
                    </div>
                    <div class="pricing-details">
                        <div class="pricing-item">
                            <div class="pricing-label">Total Value (Satoshis)</div>
                            <div class="pricing-value">${data.total_satoshis.toLocaleString()}</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-label">Total Value (BTC)</div>
                            <div class="pricing-value">${data.total_btc.toFixed(8)}</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-label">Bitcoin Price Used</div>
                            <div class="pricing-value">$${data.bitcoin_price_usd.toLocaleString()}</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-label">Block Height</div>
                            <div class="pricing-value">${data.transaction_data.block_height || 'N/A'}</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-label">Block Time</div>
                            <div class="pricing-value">${formatTimestamp(data.transaction_data.block_time)}</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-label">Status</div>
                            <div class="pricing-value">${data.transaction_data.confirmed ? 'Confirmed' : 'Pending'}</div>
                        </div>
                        <div class="pricing-item">
                            <div class="pricing-label">Calculation Time</div>
                            <div class="pricing-value">${new Date(data.calculation_time).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div class="tax-info">
                        <div class="tax-title">üìä Tax Information</div>
                        <div class="tax-note">
                            <strong>Important:</strong> This USD value calculation is for informational purposes only. 
                            For tax purposes, you should use the Bitcoin price at the time of the transaction, 
                            not the current price. Consider consulting with a tax professional for accurate 
                            cryptocurrency tax calculations.
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || timestamp === 'N/A') return 'N/A';
            
            // If timestamp is a number (Unix timestamp)
            if (typeof timestamp === 'number') {
                return new Date(timestamp * 1000).toLocaleString();
            }
            
            // If timestamp is already a date string
            const date = new Date(timestamp);
            if (!isNaN(date.getTime())) {
                return date.toLocaleString();
            }
            
            return timestamp;
        }

        // Load current price on page load
        window.addEventListener('load', function() {
            loadCurrentPrice();
            
            // Refresh price every 30 seconds
            setInterval(loadCurrentPrice, 30000);
        });
    </script>
</body>
</html>
